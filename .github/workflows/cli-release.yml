name: CLI Release

on:
    push:
        tags:
            - "cli-v*"

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - goos: linux
                      goarch: amd64
                      ext: ""
                      archive: tar.gz
                    - goos: linux
                      goarch: arm64
                      ext: ""
                      archive: tar.gz
                    - goos: darwin
                      goarch: amd64
                      ext: ""
                      archive: tar.gz
                    - goos: darwin
                      goarch: arm64
                      ext: ""
                      archive: tar.gz
                    - goos: windows
                      goarch: amd64
                      ext: ".exe"
                      archive: zip

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.22"

            - name: Build CLI
              run: |
                  mkdir -p dist
                  cd cli
                  GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 \
                    go build -o ../dist/fluxiondb-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} .

            - name: Package artifact
              run: |
                  cd dist
                  BIN="fluxiondb-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}"
                  ARCHIVE="fluxiondb-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive }}"
                  if [ "${{ matrix.archive }}" = "zip" ]; then
                    zip "$ARCHIVE" "$BIN"
                  else
                    tar -czf "$ARCHIVE" "$BIN"
                  fi

            - name: Upload release asset
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      dist/fluxiondb-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
